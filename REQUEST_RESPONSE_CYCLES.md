# Request-Response Cycles

This document provides a detailed, "fleshed out" description of the request-response cycle for each of the main functions (views) in the HopeHands Volunteer Management application.

---

## 1. `volunteer_signup` (Create)

### a. GET Request (Displaying the Signup Form)

1.  **User's Browser:** The user navigates to `http://127.0.0.1:8000/` or `http://127.0.0.1:8000/volunteer/signup/`.
2.  **Django's URL Router:** Django receives the GET request. It checks the project's `hopehands/urls.py` and the app's `volunteer/urls.py` to find a matching URL pattern. The pattern `path('signup/', views.volunteer_signup, name='signup')` matches.
3.  **View Execution (`views.py`):** The `volunteer_signup` view function is called.
    - The `request.method` is 'GET', so the `if request.method == 'POST':` block is skipped.
    - An unbound instance of `VolunteerForm` is created: `form = VolunteerForm()`.
    - The `render()` function is called with the request, the template path `'volunteer/signup.html'`, and a context dictionary `{'form': form}`.
4.  **Template Rendering (`signup.html`):**
    - Django's template engine loads `volunteer/base.html` because of the `{% extends 'volunteer/base.html' %}` tag.
    - It then renders the content of `signup.html` inside the `{% block content %}` of the base template.
    - The `{{ form.as_p }}` (or similar) in the template is replaced with the HTML for the form fields, generated by the `VolunteerForm` instance.
5.  **HTTP Response:** The fully rendered HTML is sent back to the user's browser as an HTTP response with a status code of 200 (OK).
6.  **User's Browser:** The browser receives the HTML and renders the signup form.

### b. POST Request (Submitting the Signup Form)

1.  **User's Browser:** The user fills out the signup form and clicks the "Sign Up" button. The browser sends a POST request to `/volunteer/signup/` with the form data in the request body.
2.  **Django's URL Router:** The request is routed to the `volunteer_signup` view, as before.
3.  **View Execution (`views.py`):**
    - The `request.method` is 'POST', so the `if` block is executed.
    - A bound instance of `VolunteerForm` is created with the submitted data: `form = VolunteerForm(request.POST)`.
    - The form's `is_valid()` method is called. This triggers the validation logic for each field in the form.
    - **If `is_valid()` is `True`:**
        - `volunteer = form.save()`: A new `Volunteer` object is created and saved to the local MySQL database.
        - `hubspot_api = HubspotAPI()`: An instance of our HubSpot service is created.
        - `hubspot_api.create_contact(...)`: The `create_contact` method is called with the data from the `volunteer` object.
            - **Inside `hubspot_api.py`:** A dictionary of properties is created, and the HubSpot API client is used to send a POST request to the HubSpot CRM API (`/crm/v3/objects/contacts`).
        - `return redirect('success')`: The view returns an HTTP 302 Redirect response, telling the browser to go to the URL named 'success'.
    - **If `is_valid()` is `False`:**
        - The code inside the `if form.is_valid():` block is skipped.
        - The `render()` function is called again, but this time the `form` object contains the submitted data and any validation errors.
4.  **HTTP Response / Next Request:**
    - **On successful submission:** The browser receives the 302 Redirect and sends a new GET request to the `/volunteer/success/` URL. The `success` view is executed, which renders the `success.html` template.
    - **On validation error:** The browser receives a 200 OK response with the re-rendered `signup.html` template, which now includes the validation error messages next to the relevant form fields.

---

## 2. `volunteer_list` (Read All)

### a. GET Request

1.  **User's Browser:** The user clicks on the "Volunteer List" link, which points to `/volunteer/list/`.
2.  **Django's URL Router:** The URL is matched to the `volunteer_list` view.
3.  **View Execution (`views.py`):**
    - An instance of `HubspotAPI` is created.
    - `contacts = hubspot_api.get_all_contacts()`: The service method is called.
        - **Inside `hubspot_api.py`:** The HubSpot API client sends a GET request to the HubSpot API (`/crm/v3/objects/contacts`). The list of contacts is extracted from the API response.
    - The view renders the `volunteer_list.html` template, passing the `contacts` list in the context.
4.  **Template Rendering (`volunteer_list.html`):**
    - The template iterates through the `contacts` list (`{% for contact in contacts %}`).
    - For each contact, it displays their properties (ID, name, email, etc.) in a table row.
    - It also generates links to the `volunteer_detail`, `volunteer_update`, and `volunteer_delete` views for each contact, using their HubSpot ID.
5.  **HTTP Response:** The rendered HTML is sent to the browser.

---

## 3. `volunteer_update` (Update)

### a. GET Request (Displaying the Edit Form)

1.  **User's Browser:** The user clicks the "Edit" link for a specific volunteer, which points to a URL like `/volunteer/contact/12345/update/`.
2.  **Django's URL Router:** The pattern `path('contact/<int:contact_id>/update/', ...)` matches, capturing the `contact_id`. The `volunteer_update` view is called with the `contact_id`.
3.  **View Execution (`views.py`):**
    - The `request.method` is 'GET'.
    - The `HubspotAPI` service is used to fetch the contact with the given `contact_id`.
    - An `initial_data` dictionary is created from the properties of the fetched HubSpot contact.
    - A `VolunteerForm` is instantiated with this `initial_data`: `form = VolunteerForm(initial=initial_data)`. This pre-fills the form with the contact's existing data.
    - The `volunteer_update.html` template is rendered with the pre-filled `form` and the `contact_id`.
4.  **HTTP Response:** The HTML for the edit form, with the fields populated with the volunteer's data, is sent to the browser.

### b. POST Request (Submitting the aChanges)

1.  **User's Browser:** The user modifies the data in the form and clicks "Update". A POST request is sent to the same URL (`/volunteer/contact/12345/update/`).
2.  **Django's URL Router:** The request is routed to the `volunteer_update` view.
3.  **View Execution (`views.py`):**
    - The `request.method` is 'POST'.
    - The `HubspotAPI` is used to fetch the contact again (to have it available).
    - A `VolunteerForm` is created with the submitted `request.POST` data.
    - **If `form.is_valid()` is `True`:**
        - A `properties` dictionary is created from the `form.cleaned_data`.
        - `hubspot_api.update_contact(contact_id, properties)` is called.
            - **Inside `hubspot_api.py`:** A PATCH request is sent to the HubSpot API (`/crm/v3/objects/contacts/{contactId}`) with the updated properties.
        - `return redirect('volunteer_detail', contact_id=contact_id)`: The view redirects the user to the detail page for the volunteer they just updated.
    - **If `form.is_valid()` is `False`:** The `volunteer_update.html` template is re-rendered with the form containing the errors.
4.  **HTTP Response / Next Request:** The browser either receives a 302 Redirect to the detail page or a 200 OK with the form and validation errors.

---

## 4. `volunteer_delete` (Delete)

### a. GET Request (Displaying the Confirmation Page)

1.  **User's Browser:** The user clicks the "Delete" link, which points to `/volunteer/contact/12345/delete/`.
2.  **Django's URL Router:** The URL is matched to the `volunteer_delete` view, capturing the `contact_id`.
3.  **View Execution (`views.py`):**
    - The `request.method` is 'GET'.
    - The `HubspotAPI` is used to fetch the contact to be deleted, so their name can be displayed in the confirmation message.
    - The `volunteer_delete_confirm.html` template is rendered with the `contact` object.
4.  **HTTP Response:** The HTML for the confirmation page is sent to the browser.

### b. POST Request (Confirming the Deletion)

1.  **User's Browser:** The user clicks the "Yes, delete" button on the confirmation page. A POST request is sent to the same URL.
2.  **Django's URL Router:** The request is routed to the `volunteer_delete` view.
3.  **View Execution (`views.py`):**
    - The `request.method` is 'POST'.
    - The `HubspotAPI` is used to fetch the contact's email before deleting them.
    - `hubspot_api.delete_contact(contact_id)` is called.
        - **Inside `hubspot_api.py`:** A DELETE (archive) request is sent to the HubSpot API.
    - The code then tries to find and delete the corresponding `Volunteer` object from the local database using the email address.
    - `return redirect('volunteer_list')`: The view redirects the user back to the main volunteer list page.
4.  **HTTP Response / Next Request:** The browser receives a 302 Redirect and sends a new GET request to the `/volunteer/list/` URL.

---

This detailed breakdown illustrates the flow of control and data for each key feature in the application, from the user's interaction in the browser to the backend logic and back again.
